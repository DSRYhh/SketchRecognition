%% Load data
clear;
load('norCUFS.mat');
norData = T;
load('prototype.mat');

load('MLBP.mat');
sketchFeatures = T(:,1:2:end);
galleryFeatures = T(:,2:2:end);
nt = size(T, 2) / 2;

%% Load all testing gallery data and extract features

norGallery = norData(:,:,2:2:end);
testingG = norGallery(:,:, 71:100);
testingGalleryFeatures = zeros(143 * 236, 30);
for i = 1 : size(testingGalleryFeatures, 2)
    testingGalleryFeatures(:,i) = ...
        featureExtraction(testingG(:,:,i),...
        'MLBP','csdn');
end
gallery = zeros(70, size(testingG, 3));
for i = 1 : size(gallery, 2)
    phiG = similarity(testingGalleryFeatures(:, i),...
        galleryFeatures);
    gallery(:,i) = ...
        [ones(size(phiG,2),1) (phiG - transpose(mu))'] * W';
end

%% Choose a random 
index = 99;
I = norData(:, :, index);
sketchFeature = featureExtraction(I, 'MLBP', 'csdn');
phiP = similarity(sketchFeature, sketchFeatures);
% probe = transpose(W)*(phiP - transpose(mu));
probe = [ones(size(phiP,2),1) (phiP - transpose(mu))'] * W';

